ğŸ«

DNS Relay Lab
Qingyu Wu
University of Science and Technology of China
2025-10-05

A. Introduction

Background

A. Introduction ğŸ«

IPv4
â€¢ ç¬¬å››ç‰ˆäº’è”ç½‘åè®®ï¼Œä½äºç½‘ç»œå±‚
â€¢ ä½¿ç”¨ 32 ä½æ— ç¬¦å·æ•´æ•°æ ‡è¯†äº’è”ç½‘ä¸Šçš„ä¸»æœº
â€¢ å¸¸è§çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼
â€£ 202.38.64.59ï¼šä¸­ç§‘å¤§ç½‘ç»œé€šåœ°å€
IPv6
â€¢ ç¬¬å…­ç‰ˆäº’è”ç½‘åè®®ï¼Œä½äºç½‘ç»œå±‚
â€¢ ä½¿ç”¨ 128 ä½æ— ç¬¦å·æ•´æ•°æ ‡è¯†äº’è”ç½‘ä¸Šçš„ä¸»æœº
â€¢ å¸¸è§çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼
â€£ 2409:8c00:6c21:1051:0:ff:b0af:279aï¼šä¸€ä¸ªåŒ—äº¬ç”¨æˆ·çš„åœ°å€
Qingyu Wu

DNS Relay Lab

2025-10-05

2 / 41

Background

A. Introduction ğŸ«

Socket
â€¢ å¥—æ¥å­—ï¼Œé€šå¸¸æŒ‡çš„æ˜¯è¿è¡Œåœ¨åº”ç”¨å±‚å’Œä¼ è¾“å±‚ä¹‹é—´çš„æ¥å£æœåŠ¡
â€¢ åŸºäº TCP/IP çš„äº’è”ç½‘ä¸­å¸¸ç”¨çš„æ˜¯ TCP Socket å’Œ UDP Socket
â€£ TCP Socket æä¾›å¯é å­—èŠ‚æµï¼ˆreliable byte streamï¼‰ä¼ è¾“æœåŠ¡
â€£ UDP Socket æä¾›ä¸å¯é æ•°æ®åŒ…ï¼ˆunreliable datagramï¼‰ä¼ è¾“æœåŠ¡
Domain Name System (DNS)
â€¢ åŸŸåç³»ç»Ÿï¼Œä¸€ç§åˆ†å±‚åˆ†å¸ƒå¼åç§°æœåŠ¡ï¼Œè¿è¡Œåœ¨åº”ç”¨å±‚
â€¢ å®ç°åŸŸåå’Œ IP åœ°å€ä¹‹é—´çš„æ˜ å°„
â€¢ åŸºäº UDP åè®®è¿è¡Œåœ¨ä¸»æœº 53 ç«¯å£ä¸Š

Qingyu Wu

DNS Relay Lab

2025-10-05

3 / 41

Background

A. Introduction ğŸ«

hosts
â€¢ ä¸»æœºæ–‡ä»¶ï¼Œå°†åŸŸåï¼ˆä¸»æœºåï¼‰ç›´æ¥æ˜ å°„ä¸º IP åœ°å€çš„æœ¬åœ°é…ç½®æ–‡ä»¶
â€£ Windows ä¸‹ï¼Œä½äº C:\Windows\System32\drivers\etc\hosts
â€£ Linux ä¸‹ï¼Œä½äº /etc/hosts
â€¢ ä½¿ç”¨ # è¡¨ç¤ºè¡Œæ³¨é‡Šï¼Œä¸€è¡Œä¸€ä¸ªæ˜ å°„æ¡ç›®ï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š
IP_address canonical_hostname [aliases...]

â€£ å…¶ä¸­ aliases æ˜¯åŒä¸€ä¸ªä¸»æœºåçš„åˆ«åï¼Œè¯´æ˜ä¸€ä¸ªæ˜ å°„æ¡ç›®å¯ä»¥åŒ
æ—¶è¡¨ç¤ºå¤šä¸ªä¸»æœºåçš„æ˜ å°„

Qingyu Wu

DNS Relay Lab

2025-10-05

4 / 41

Background

A. Introduction ğŸ«

hosts
â€¢ ä¸»æœºæ–‡ä»¶ï¼Œå°†åŸŸåï¼ˆä¸»æœºåï¼‰ç›´æ¥æ˜ å°„ä¸º IP åœ°å€çš„æœ¬åœ°é…ç½®æ–‡ä»¶
â€£ Windows ä¸‹ï¼Œä½äº C:\Windows\System32\drivers\etc\hosts
â€£ Linux ä¸‹ï¼Œä½äº /etc/hosts
â€¢ Linux ä¸‹ä¸»æœºæ–‡ä»¶é€šå¸¸åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
# Static table lookup for hostnames.
# See hosts(5) for details.
127.0.0.1
localhost
::1
localhost

å³å°†ä¸»æœºå localhost ç»‘å®šåˆ°å›ç¯åœ°å€ 127.0.0.1ï¼ˆIPv4ï¼‰ å’Œ ::1
ï¼ˆIPv6ï¼‰
Qingyu Wu

DNS Relay Lab

2025-10-05

4 / 41

Background

A. Introduction ğŸ«

mappings
ä¸ºäº†ä¸é€ æˆåç§°ä¸Šçš„æ··æ·†ï¼Œæœ¬å®éªŒä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„æ–‡ä»¶ mappings è¡¨
ç¤ºæœ¬å®éªŒä¸­ä½¿ç”¨çš„æœ¬åœ°åŸŸå IP æ˜ å°„æ–‡ä»¶ï¼Œä»è€ŒåŒºåˆ«äºç³»ç»Ÿè‡ªå¸¦çš„
hosts æ–‡ä»¶ï¼Œè§„å®šå¦‚ä¸‹ï¼š
â€¢ mappings æ–‡ä»¶çš„æ ¼å¼å’Œ hosts æ–‡ä»¶å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯æ–‡ä»¶åçš„ä¸åŒ
â€¢ mappings æ–‡ä»¶å­˜æ”¾åœ¨å®éªŒæ¡†æ¶çš„æ ¹ç›®å½•ä¸‹ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
...
192.168.1.1
192.168.3.1
2409::1
...
Qingyu Wu

www.test1.com test1-v4 test
www.test1.com
www.test1.com test1-v6

DNS Relay Lab

2025-10-05

5 / 41

Background

A. Introduction ğŸ«

DNS Relay
â€¢ DNS ä¸­ç»§å™¨ï¼Œä¸€ç§ä½äºä¸»æœºå’Œ DNS æœåŠ¡å™¨ä¹‹é—´çš„ä¸­ç»§æœåŠ¡
â€¢ ç»Ÿä¸€ç®¡ç†å¤šä¸ªä¸»æœºçš„ä¸Šæ¸¸ DNS æœåŠ¡å™¨ï¼Œä»…éœ€ä¿®æ”¹ DNS ä¸­ç»§å™¨å³å¯
â€¢ å¸¸ç”¨äºè·¯ç”±å™¨ï¼ˆæ­é… DHCP æœåŠ¡å™¨è¿”å›ç½‘å…³ IP ä½œä¸º DNS ä¸­ç»§å™¨ï¼‰

Qingyu Wu

DNS Relay Lab

2025-10-05

6 / 41

Background

A. Introduction ğŸ«

DNS Proxy
â€¢ DNS ä»£ç†ï¼Œä¸€ç§ä»£ç†ä¸»æœºè¯·æ±‚å“åº” DNS æœåŠ¡å™¨çš„ä»£ç†æœåŠ¡
â€¢ ç›¸æ¯”äº DNS ä¸­ç»§å™¨ï¼Œå¢åŠ ç¼“å­˜ã€æœ¬åœ°è§£æï¼Œä¿®æ”¹ DNS æŠ¥æ–‡åŠŸèƒ½
â€¢ å¸¸ç”¨äºè·¯ç”±å™¨ï¼Œä¸»æœºï¼ˆç»•è¿‡ DNS æ±¡æŸ“æ”»å‡»ï¼‰

Qingyu Wu

DNS Relay Lab

2025-10-05

7 / 41

Background

A. Introduction ğŸ«

Little Endian
â€¢ å°ç«¯åºï¼Œå³ä¸€ä¸ªç”±å¤šä¸ªå­—èŠ‚æ„æˆçš„æ•°çš„é«˜ä½å­—èŠ‚å­˜æ”¾åœ¨å†…å­˜åœ°å€
çš„é«˜ä½ï¼Œä½ä½å­—èŠ‚å­˜æ”¾åœ¨ä½ä½
â€¢ ç›®å‰å¤§éƒ¨åˆ†è®¡ç®—æœºä½¿ç”¨çš„ä¸»æœºåºï¼ˆhost byte orderï¼‰éƒ½æ˜¯å°ç«¯åº
Big Endian
â€¢ å¤§ç«¯åºï¼Œå³ä¸€ä¸ªç”±å¤šä¸ªå­—èŠ‚æ„æˆçš„æ•°çš„é«˜ä½å­—èŠ‚å­˜æ”¾åœ¨å†…å­˜åœ°å€
çš„ä½ä½ï¼Œä½ä½å­—èŠ‚å­˜æ”¾åœ¨é«˜ä½
â€¢ å°éƒ¨åˆ†è®¡ç®—æœºä»¥åŠå¤§éƒ¨åˆ†ç½‘ç»œä¼ è¾“åè®®ï¼ˆåŒ…æ‹¬ DNSï¼‰ä½¿ç”¨çš„æ˜¯éƒ½
æ˜¯å¤§ç«¯åºï¼ŒAppendix ä¸­ä»‹ç»äº†ä¸€äº› Linux ä¸‹æ–¹ä¾¿çš„ä»ä¸»æœºåºè½¬æ¢
æˆç½‘ç»œå¤§ç«¯åºçš„åº“å‡½æ•°
Qingyu Wu

DNS Relay Lab

2025-10-05

8 / 41

Background

A. Introduction ğŸ«

DNS datagram
DNS datagram çš„æ ¼å¼ç”± RFC 1035Â¹ è§„å®šã€‚ä¸å®šé•¿å­—æ®µä¼šç‰¹åˆ«è¯´æ˜ã€‚
å¯¹äº DNS è¯·æ±‚ï¼ˆrequestï¼‰æŠ¥æ–‡ï¼Œå…¶æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

å…¶ä¸­ Question Section å®é™…ä¸Šæ˜¯ä¸å®šé•¿çš„ã€‚
Â¹https://www.rfc-editor.org/rfc/rfc1035
Qingyu Wu

DNS Relay Lab

2025-10-05

9 / 41

Background

A. Introduction ğŸ«

DNS datagram
å¯¹äº DNS å“åº”ï¼ˆresponseï¼‰æŠ¥æ–‡ï¼Œå…¶æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

å…¶ä¸­é™¤äº† Header Section å…¶ä»– Section å®é™…ä¸Šæ˜¯ä¸å®šé•¿çš„ã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

9 / 41

Background

A. Introduction ğŸ«

DNS Header Section

ä¸è®ºæ˜¯ DNS è¯·æ±‚è¿˜æ˜¯å“åº”æŠ¥æ–‡ï¼Œé™¤å»åé¢çš„ Section éƒ¨åˆ†éƒ½ç§°ä½œ
Header Sectionï¼Œå…¶ä¸­å„ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š
â€¢ IDï¼šä¸€ä¸ªè¯·æ±‚å“åº”è¿‡ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
â€£ ç”±äº UDP åè®®æ˜¯é¢å‘æ— è¿æ¥çš„ï¼Œå› æ­¤éœ€è¦ ID å­—æ®µå°†å‘é€çš„è¯·æ±‚
æŠ¥æ–‡å’Œæ”¶åˆ°çš„å“åº”æŠ¥æ–‡ä¸€ä¸€å¯¹åº”èµ·æ¥ã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

10 / 41

Background

A. Introduction ğŸ«

DNS Header Section

â€¢ QRï¼š0 è¡¨ç¤ºè¯·æ±‚æŠ¥æ–‡ï¼Œ1 è¡¨ç¤ºå“åº”æŠ¥æ–‡
â€¢ OPCODEï¼š0 è¡¨ç¤ºæ ‡å‡†æŸ¥è¯¢ï¼Œ1 è¡¨ç¤ºåå‘æŸ¥è¯¢ï¼ˆIP æŸ¥åŸŸåï¼‰ï¼Œ2 è¡¨ç¤º
æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢ï¼Œ3-15 ä¿ç•™åˆ°ä»¥åä½¿ç”¨
â€¢ AAï¼š1 è¡¨ç¤ºæ˜¯æƒå¨æœåŠ¡å™¨å“åº”ï¼Œ0 è¡¨ç¤ºä¸æ˜¯
â€¢ TCï¼š1 è¡¨ç¤ºæŠ¥æ–‡å¤ªå¤§è¶…è¿‡ç‰©ç†ä¿¡é“é™åˆ¶è€Œè¢«æˆªæ–­ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰
Qingyu Wu

DNS Relay Lab

2025-10-05

10 / 41

Background

A. Introduction ğŸ«

DNS Header Section

â€¢ RDï¼š1 è¡¨ç¤ºæœŸæœ›ä½¿ç”¨é€’å½’æŸ¥è¯¢æ–¹å¼ï¼Œ0 è¡¨ç¤ºä¸æœŸæœ›ï¼ˆåªåœ¨è¯·æ±‚æŠ¥æ–‡
ä¸­æœ‰æ•ˆï¼‰
â€¢ RAï¼š1 è¡¨ç¤ºå¯ä»¥ä½¿ç”¨é€’å½’æŸ¥è¯¢æ–¹å¼ï¼Œ0 è¡¨ç¤ºä¸å¯ä»¥ï¼ˆåªåœ¨å“åº”æŠ¥æ–‡
ä¸­æœ‰æ•ˆï¼‰
â€¢ Zï¼šä¿ç•™å­—æ®µï¼Œä¸è®ºè¯·æ±‚å“åº”å¿…é¡»ä¸ºå…¨ 0
Qingyu Wu

DNS Relay Lab

2025-10-05

10 / 41

Background

A. Introduction ğŸ«

DNS Header Section

â€¢ RCODEï¼š0 è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œ1 è¡¨ç¤ºæ ¼å¼é”™è¯¯ï¼Œ2 è¡¨ç¤ºæœåŠ¡å™¨æ— æ³•å¤„
ç†ï¼Œ3 è¡¨ç¤ºæ‰¾ä¸åˆ°è¯¥åŸŸåï¼ˆåªæœ‰ AA = 1 æ—¶æœ‰æ•ˆï¼‰ï¼Œç­‰ç­‰
â€¢ QDCOUNTï¼šQuestion Section ä¸­åŒ…å«çš„è¯·æ±‚æ¡ç›®æ•°
â€¢ ANCOUNTï¼šAnswer Section ä¸­åŒ…å«çš„èµ„æºè®°å½•æ•°
â€¢ NSCOUNTï¼šAuthority Section ä¸­åŒ…å«çš„æƒå¨æœåŠ¡å™¨æ•°
â€¢ ARCOUNTï¼šAdditional Section ä¸­åŒ…å«çš„èµ„æºè®°å½•æ•°
Qingyu Wu

DNS Relay Lab

2025-10-05

10 / 41

Background

A. Introduction ğŸ«

DNS Question Section
Question Section åŒ…å«äº†æ‰€æœ‰ DNS è¯·æ±‚æ¡ç›®ï¼ˆentryï¼‰ã€‚
ä¸è®ºæ˜¯ DNS è¯·æ±‚è¿˜æ˜¯å“åº”æŠ¥æ–‡ï¼Œéƒ½åŒ…å« Question Sectionï¼ŒåŒä¸€ä¸ª
ID ä¸‹å“åº”æŠ¥æ–‡çš„ Question Section ä¿æŒå’Œè¯·æ±‚æŠ¥æ–‡ç›¸åŒã€‚
Question Section ç”±å¤šä¸ª entry æ„æˆã€‚ç”±äºåŸŸåé•¿åº¦æ˜¯ä¸å›ºå®šçš„ï¼Œæ¯
ä¸ª entry çš„é•¿åº¦ä¹Ÿæ˜¯ä¸å›ºå®šçš„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

Qingyu Wu

DNS Relay Lab

2025-10-05

11 / 41

Background

A. Introduction ğŸ«

DNS Question Section

â€¢ QNAMEï¼šè¢«æŸ¥è¯¢çš„åŸŸåï¼Œä¸å®šé•¿ï¼Œè¢«è¡¨ç¤ºæˆä¸€ä¸² label åºåˆ—ã€‚æ¯
ä¸ª label ç”±ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºçš„ length ä»¥åŠä¸€ä¸ª length é•¿çš„å­—ç¬¦åºåˆ—æ„
æˆã€‚label åºåˆ—ä»¥ä¸€ä¸ª '\0' å­—èŠ‚è¡¨ç¤º 0 é•¿å­—ç¬¦åºåˆ—ç»“æŸã€‚
â€£ æ¯”å¦‚ï¼Œwww.baidu.com è¢«è¡¨ç¤ºæˆå¦‚ä¸‹æ ¼å¼ï¼š

Qingyu Wu

DNS Relay Lab

2025-10-05

12 / 41

Background

A. Introduction ğŸ«

DNS Question Section

â€¢ QTYPEï¼šè¢«æŸ¥è¯¢çš„èµ„æºè®°å½•ï¼ˆresource recordsï¼‰çš„ç±»å‹ï¼ˆtypeï¼‰ï¼Œ
å¸¸ç”¨çš„ QTYPE æœ‰ï¼š
â€£ 1 (A)ï¼šè¡¨ç¤º IPv4 åœ°å€è®°å½•
â€£ 28 (AAAA)ï¼šè¡¨ç¤º IPv6 åœ°å€è®°å½•
â€£ 5 (CNAME)ï¼šåŸŸååˆ«åè®°å½•
â€£ 16 (TXT)ï¼šä»»æ„æ–‡æœ¬è®°å½•
Qingyu Wu

DNS Relay Lab

2025-10-05

12 / 41

Background

A. Introduction ğŸ«

DNS Question Section

â€¢ QCLASSï¼šè¢«æŸ¥è¯¢çš„èµ„æºè®°å½•çš„ç±»åˆ«ï¼ˆclassï¼‰ï¼Œå¸¸ç”¨çš„ QCLASS å°±
æ˜¯ 1 (IN)ï¼Œè¡¨ç¤ºäº’è”ç½‘ç±»åˆ«ä¸‹çš„è®°å½•ï¼Œå…¶ä½™çš„å€¼å¯ä»¥æ˜¯ï¼š
â€£ 2 (CS)ï¼šè¡¨ç¤º CSNET ç±»åˆ«ï¼ˆå·²è¿‡æ—¶ï¼‰
â€£ 3 (CH)ï¼šè¡¨ç¤º CHAOSÂ¹ ç±»åˆ«ï¼ˆåŸºæœ¬è¢«å–ä»£ï¼‰
â€£ 4 (HS)ï¼šè¡¨ç¤º HesiodÂ² ç±»åˆ«ï¼ˆåŸºæœ¬è¢«å–ä»£ï¼‰
Â¹https://chaosnet.net/
Â²https://simonwo.net/technical/hesiod/
Qingyu Wu

DNS Relay Lab

2025-10-05

12 / 41

Background

A. Introduction ğŸ«

DNS Answer Section
Answer Section åŒ…å«äº†éƒ¨åˆ† DNS èµ„æºè®°å½•ï¼Œåªä¼šåœ¨å“åº”æŠ¥æ–‡ä¸­å‡ºç°ã€‚
Answer Section ç”±å¤šä¸ªèµ„æºè®°å½•æ„
æˆã€‚ç”±äºåŸŸåé•¿åº¦æ˜¯ä¸å›ºå®šçš„ï¼Œæ¯
ä¸ªèµ„æºè®°å½•çš„é•¿åº¦ä¹Ÿæ˜¯ä¸å›ºå®šçš„ï¼Œ
å…¶æ ¼å¼å¦‚å³å›¾æ‰€ç¤ºï¼š
å…¶ä¸­ NAMEã€TYPEã€CLASS å­—æ®µ
çš„å¯é€‰å€¼å’Œå«ä¹‰å’Œ Question
Section ä¸­çš„åŸºæœ¬ç›¸åŒ
Qingyu Wu

DNS Relay Lab

2025-10-05

13 / 41

Background

A. Introduction ğŸ«

DNS Answer Section
Answer Section åŒ…å«äº†éƒ¨åˆ† DNS èµ„æºè®°å½•ï¼Œåªä¼šåœ¨å“åº”æŠ¥æ–‡ä¸­å‡ºç°ã€‚
â€¢ TTLï¼šè¯¥èµ„æºè®°å½•åº”è¯¥è¢«ç¼“å­˜çš„
æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œ0 è¡¨ç¤ºä¸åº”è¯¥
è¢«ç¼“å­˜
â€¢ RDLENGTHï¼šRDATA å­—æ®µçš„é•¿
åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚
â€¢ RDATAï¼šè¯¥èµ„æºè®°å½•çš„å†…å®¹ï¼Œä¸
å®šé•¿ï¼Œæ¯”å¦‚å¯¹äº A è®°å½•ï¼Œå­˜æ”¾çš„
å°±æ˜¯ 32 ä½ IPv4 åœ°å€
Qingyu Wu

DNS Relay Lab

2025-10-05

13 / 41

Background

A. Introduction ğŸ«

DNS Authority Section
Authority Section åŒ…å«äº†æƒå¨æœåŠ¡å™¨çš„èµ„æºè®°å½•ï¼Œåªä¼šåœ¨å“åº”æŠ¥æ–‡ä¸­
å‡ºç°ï¼Œå’Œ Answer Section çš„ç»“æ„å®Œå…¨ä¸€æ ·ï¼Œé€šå¸¸å­˜æ”¾ NS ç±»å‹çš„èµ„æº
è®°å½•ï¼Œç”¨äºè¡¨æ˜è¢«æŸ¥è¯¢åŸŸåæ‰€å±çš„æƒå¨æœåŠ¡å™¨ã€‚æœ¬æ¬¡å®éªŒä¸ç”¨ã€‚
DNS Additional Section
Additional Section åŒ…å«äº†é¢å¤–æä¾›çš„èµ„æºè®°å½•ï¼Œåªä¼šåœ¨å“åº”æŠ¥æ–‡ä¸­
å‡ºç°ï¼Œå’Œ Answer Section çš„ç»“æ„å®Œå…¨ä¸€æ ·ï¼Œé€šå¸¸å­˜æ”¾ A/AAAA ç±»å‹
çš„èµ„æºè®°å½•ï¼Œç”¨äºè¡¨æ˜ Authority Section é‡Œçš„æƒå¨æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œ
å‡å°‘ä¸å¿…è¦çš„å†æ¬¡æŸ¥è¯¢ã€‚æœ¬æ¬¡å®éªŒä¸ç”¨ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

14 / 41

Background

A. Introduction ğŸ«

DNS Message Compression
ä¸ºäº†ç¼©çŸ­ DNS æŠ¥æ–‡å¤§å°ï¼ŒRFC 1035 è¿˜è§„å®šäº†ä¸€ç§å‡å°‘é‡å¤è¡¨ç¤ºåŸŸå
çš„å‹ç¼©æ–¹æ¡ˆï¼ˆcompression schemeï¼‰ã€‚
å¦‚æœä¹‹å‰åœ¨æ•´ä¸ª DNS datagram çš„ offset å­—èŠ‚å¤„å·²ç»å­˜æ”¾äº†ä¸€ä¸ªç”±
label åºåˆ—æ„æˆçš„åŸŸåï¼Œé‚£ä¹ˆåœ¨ä¹‹åå­˜æ”¾åŸŸåçš„å­—æ®µä¸­ï¼Œå¯ä»¥ç›´æ¥å­˜
æ”¾ä¸€ä¸ª 16 ä½çš„æŒ‡é’ˆï¼Œå…¶æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

å…¶ä¸­ï¼Œå¼€å¤´ä¸¤ä½ä»…ç”¨äºåŒºåˆ†å½“å‰å­—æ®µå­˜æ”¾çš„æ˜¯æŒ‡é’ˆè¿˜æ˜¯ label åºåˆ—ï¼Œ
å¯¹äº label åºåˆ—ï¼Œè¿™ä¸¤ä½ä¸€å®šæ˜¯ 0ï¼Œå› ä¸ºå•ä¸ª label ä¸èƒ½è¶…è¿‡ 63 å­—èŠ‚ã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

15 / 41

B. Overall

Introduction

B. Overall ğŸ«

DNS Relay with local resolve
æœ¬æ¬¡å®éªŒçš„å®éªŒæ¡†æ¶æ˜¯ä¸€ä¸ªä½¿ç”¨ C è¯­è¨€é€šè¿‡ Linux Socket åº“å®ç°çš„
å¸¦æœ‰æœ¬åœ°è§£æåŠŸèƒ½çš„ DNS ä¸­ç»§å™¨ã€‚
ç›¸æ¯”äº DNS Relayï¼Œæˆ‘ä»¬è¿˜éœ€é¢å¤–å®ç°é€šè¿‡è¯»å– mappings æ–‡ä»¶ç›´æ¥
æœ¬åœ°è§£æåŸŸåçš„åŠŸèƒ½ï¼Œä»è€Œèƒ½æ‰‹åŠ¨æ§åˆ¶åŸŸåè§£æçš„è¿‡ç¨‹ã€‚
ç›¸æ¯”äº DNS Proxyï¼Œæˆ‘ä»¬æ— éœ€å®ç°ç¼“å­˜åŠŸèƒ½ï¼Œä»è€Œå¢åŠ ä¸è¿™é—¨è¯¾ç¨‹
æ— å…³çš„å·¥ä½œé‡ï¼ˆç¼“å­˜ç­–ç•¥ç®—æ³•ï¼Œæ–‡ä»¶æ›´æ–°æ£€æµ‹ï¼‰

Qingyu Wu

DNS Relay Lab

2025-10-05

17 / 41

Prerequisites

B. Overall ğŸ«

System
ç”±äºæœ¬æ¬¡å®éªŒçš„å®éªŒæ¡†æ¶æ˜¯ä½¿ç”¨ C ç¼–å†™çš„ï¼Œç¼ºä¹å¯ç§»æ¤æ€§ï¼Œå› æ­¤å®
éªŒæ¡†æ¶åªèƒ½è·‘åœ¨ Linux ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ Windows Subsystem Linux
(WSL)ã€VLabã€è™šæ‹Ÿæœºç­‰å½¢å¼å®Œæˆæ­¤ Labã€‚
Build tools
æœ¬æ¬¡å®éªŒä½¿ç”¨ gcc ç¼–è¯‘å™¨å’Œ GNU Make æ„å»ºå·¥å…·ï¼Œåœ¨ Ubuntu/Debian
ä¸‹å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…å¹¶æŸ¥çœ‹æ˜¯å¦æ­£ç¡®å®‰è£…ï¼š
sudo apt update && sudo apt install gcc make
gcc --version && make --version

Qingyu Wu

DNS Relay Lab

2025-10-05

18 / 41

Prerequisites

B. Overall ğŸ«

Test scripts
æœ¬æ¬¡å®éªŒä½¿ç”¨çš„ nslookup å·¥å…·å¯èƒ½åœ¨æŸäº› Linux å‘è¡Œç‰ˆä¸­é»˜è®¤æ²¡æœ‰
å®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ã€‚
åœ¨ Ubuntu/Debian ä¸‹å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…å¹¶æŸ¥çœ‹æ˜¯å¦æ­£ç¡®å®‰è£…ï¼š
sudo apt update
sudo apt install dnsutils
nslookup -version

Qingyu Wu

DNS Relay Lab

2025-10-05

19 / 41

Prerequisites

B. Overall ğŸ«

Test scripts
æœ¬æ¬¡å®éªŒä½¿ç”¨çš„ benchmark è„šæœ¬ä½¿ç”¨ Python ç¼–å†™ï¼Œè°ƒç”¨ dnspython
åº“ï¼Œå› æ­¤è¿˜éœ€è¦å®‰è£…ç›¸å…³ä¾èµ–åº“ã€‚
åœ¨ Ubuntu/Debian ä¸‹å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…å¹¶æŸ¥çœ‹æ˜¯å¦æ­£ç¡®å®‰è£…ï¼š
sudo apt update
sudo apt install python-is-python3 python3-dnspython
python -c "import dns.resolver"

å¦‚æœä½ åªæƒ³åœ¨ venv æˆ– conda ä¸­å®‰è£…ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
pip install dnspython
python -c "import dns.resolver"
Qingyu Wu

DNS Relay Lab

2025-10-05

19 / 41

Build

B. Overall ğŸ«

Makefile

C Flags

æœ¬æ¬¡å®éªŒçš„å®éªŒæ¡†æ¶ä½¿ç”¨

æœ¬æ¬¡å®éªŒçš„å®éªŒæ¡†æ¶ä½¿ç”¨ä»¥ä¸‹ç¼–

Makefile ç»„ç»‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç¼–è¯‘è¿

è¯‘é€‰é¡¹ï¼š

è¡Œè¿‡ç¨‹ï¼Œä½¿ç”¨è¯´æ˜å¦‚ä¸‹æ‰€ç¤ºï¼š

-O2 -Wall -Wextra -Werror

â€¢ æ„å»ºæ¡†æ¶ï¼šmake

è¿™äº›ç¼–è¯‘é€‰é¡¹ä¼šå°½å¯èƒ½æ‰¾åˆ°ç¼–å†™

â€¢ è¿è¡Œæ¡†æ¶ï¼šmake run

çš„ä»£ç ä¸­æ½œåœ¨çš„é—®é¢˜ï¼ˆæ¯”å¦‚æœªä½¿

â€¢ æ¸…ç†ä¸­é—´æ–‡ä»¶ï¼šmake clean

ç”¨çš„å˜é‡ï¼Œæ˜“è¯¯å¯¼çš„ä»£ç æ ¼å¼ï¼‰
å¹¶ä»¥ error çš„å½¢å¼ç»ˆæ­¢ç¼–è¯‘ï¼Œå› 
æ­¤è¯·å°½å¯èƒ½ä¿è¯ä»£ç è§„èŒƒæ•´æ´ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

20 / 41

Test

B. Overall ğŸ«

nslookup
nslookup æ˜¯ä¸€ä¸ªç”¨äºæŸ¥è¯¢ DNS æœåŠ¡å™¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä½¿ç”¨æ–¹æ³•ï¼š
nslookup [options] <domain_name> [dns_server]

æ¯”å¦‚ï¼Œå½“åœ¨ä¸€ä¸ªç»ˆç«¯ä¸­ä½¿ç”¨ make run è¿è¡Œèµ·æ¥æ¡†æ¶åï¼Œåœ¨å¦ä¸€ä¸ªç»ˆ
ç«¯ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•ä¸­ç»§åŠŸèƒ½ï¼š
nslookup www.baidu.com 127.0.0.1

æµ‹è¯•æœ¬åœ°è§£æåŠŸèƒ½ï¼š
nslookup www.test1.com 127.0.0.1

Qingyu Wu

DNS Relay Lab

2025-10-05

21 / 41

Test

B. Overall ğŸ«

nslookup
ä»¥ä¸‹æ˜¯è¿è¡Œ nslookup åçš„ç¤ºä¾‹è¾“å‡ºï¼š

Qingyu Wu

DNS Relay Lab

2025-10-05

21 / 41

Test

B. Overall ğŸ«

Benchmark
é™¤äº†ä½¿ç”¨ nslookup æ‰‹åŠ¨æŸ¥è¯¢ï¼Œæˆ‘ä»¬è¿˜æä¾›äº† benchmark è„šæœ¬ï¼Œåˆ†åˆ«
ç”¨äºæµ‹è¯•æœ¬åœ°è§£æå’Œä¸­ç»§çš„æ€§èƒ½ã€‚ï¼ˆè®°å¾—åœ¨å…¶ä»–ç»ˆç«¯å…ˆè·‘èµ·æ¥æ¡†æ¶å†
è¿è¡Œè„šæœ¬ï¼‰
æµ‹è¯•ä¸­ç»§åŠŸèƒ½ï¼š
./benchmark_remote.sh

æµ‹è¯•æœ¬åœ°è§£æåŠŸèƒ½ï¼š
./benchmark_local.sh

Qingyu Wu

DNS Relay Lab

2025-10-05

22 / 41

Test

B. Overall ğŸ«

Benchmark
ä»¥ä¸‹æ˜¯è¿è¡Œ benchmark è„šæœ¬åçš„ç¤ºä¾‹è¾“å‡ºï¼š

Qingyu Wu

DNS Relay Lab

2025-10-05

22 / 41

Test

B. Overall ğŸ«

Browser
Linux çš„ DNS é…ç½®æ–‡ä»¶ä½äº /etc/resolv.confï¼Œé€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»
åŠ ä»¥ä¸‹è¡Œï¼Œå¯ä»¥å°†é»˜è®¤ DNS æœåŠ¡å™¨å®šä½åˆ°æœ¬åœ°çš„ DNS ä¸­ç»§å™¨ï¼š
nameserver 127.0.0.1

ç°åœ¨ï¼Œä½ å¯ä»¥é€šè¿‡ä¿®æ”¹ mappings æ–‡ä»¶æ§åˆ¶è¿™å°ç”µè„‘çš„ DNS è§£æè¿‡
ç¨‹äº†ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½ å°† www.baidu.com è§£ææˆ 127.0.0.1ï¼Œé‚£ä¹ˆæ‰“å¼€
firefox åè®¿é—® www.baidu.com ä¼šå‘ç°æ‰“ä¸å¼€ç½‘é¡µï¼›å†æ¯”å¦‚ï¼Œå¦‚æœä½ 
å°†é¡µé¢ä¸Šå¹¿å‘Šèµ„æºçš„ URL ä¸­çš„åŸŸåè§£ææˆ 0.0.0.0 æˆ–è€… 127.0.0.1ï¼Œ
é‚£ä¹ˆé¡µé¢ä¸Šçš„å¹¿å‘Šå°±ä¼šè¢«å±è”½ã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

23 / 41

Evaluation

B. Overall ğŸ«

Correctness (25%)
æ­£ç¡®æ€§æ£€éªŒç”± nslookup è°ƒç”¨å’Œ benchmark è„šæœ¬ç»„æˆï¼Œè¦æ±‚å®éªŒå®Œæˆ
åéƒ½èƒ½æ­£ç¡®è¿è¡Œã€‚è¿è¡Œç»“æœæ”¾åœ¨å®éªŒæŠ¥å‘Šçš„æˆªå›¾é‡Œã€‚
Report (25%)
å®éªŒå®Œæˆåï¼Œéœ€è¦æäº¤ä¸€ä»½å®éªŒæŠ¥å‘Šï¼Œè¦æ±‚å¦‚ä¸‹ï¼š
â€¢ è§£é‡Šä»£ç ç»“æ„å’Œä½œç”¨ï¼Œè®²è¿°è‡ªå·±å®ç°çš„è¡¥å…¨éƒ¨åˆ†çš„é€»è¾‘
â€¢ æˆªå›¾å±•ç¤ºå®éªŒç»“æœï¼ŒåŒ…å« nslookup å’Œ benchmark ç»“æœ

Qingyu Wu

DNS Relay Lab

2025-10-05

24 / 41

Evaluation

B. Overall ğŸ«

Demonstration (50%)
å®éªŒå®Œæˆåï¼Œå®éªŒæ£€æŸ¥ä¼šæä¾›æ–°çš„é…ç½®æ–‡ä»¶ï¼Œç°åœºä½¿ç”¨æ–°çš„
mappings æ–‡ä»¶å’Œæ–°çš„ benchmark è„šæœ¬æµ‹è¯•ï¼Œå°½å¯èƒ½åŒ…å«å¤šçš„ corner
casesã€‚
åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›ä¸€ä»½ mappings æ–‡ä»¶ç”¨äºè¿‡æ»¤ä¸€ä¸ªç½‘é¡µçš„å¹¿å‘Šï¼Œ
ç°åœºæ¼”ç¤ºé€šè¿‡ DNS ä¸­ç»§å™¨å®ç°å¹¿å‘Šè¿‡æ»¤ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

24 / 41

Submission

B. Overall ğŸ«

â€¢ æäº¤åœ°ç‚¹ï¼šbb.ustc.edu.cn çš„â€œä½œä¸šåŒºâ€
â€¢ æäº¤æ–‡ä»¶ï¼šä¸€ä¸ª zip æ ¼å¼çš„å‹ç¼©åŒ…
â€£ å‘½åæ ¼å¼ï¼šå­¦å·-å§“å-DNS_Relay.zip
â€£ åŒ…å«æ–‡ä»¶ï¼š
â€“ ä¸€ä¸ª pdf æ ¼å¼çš„å®éªŒæ–‡æ¡£
â€¢ å‘½åæ ¼å¼ï¼šå­¦å·-å§“å-DNS_Relay.pdf
â€“ ä¸¤ä¸ªåŒ…å« TODO éƒ¨åˆ†çš„ c æ ¼å¼çš„æºä»£ç æ–‡ä»¶
â€¢ dns_dgram_utils.c
â€¢ dns_relay.c

Qingyu Wu

DNS Relay Lab

2025-10-05

25 / 41

Timeline

B. Overall ğŸ«

â€¢ 9.23 å®éªŒå‘å¸ƒ
â€£ æ–‡æ¡£å’Œä»£ç å‘å¸ƒåœ¨ bb.ustc.edu.cn çš„â€œä½œä¸šåŒºâ€
â€£ ä»£ç ä¹Ÿæ”¯æŒç›´æ¥ç”¨ git clone ä¸‹æ¥ï¼š
git clone https://github.com/Vertsineu/dns-relay-lab.git

ä¹‹å‰å¼€å‘å®éªŒæ¡†æ¶çš„ commits å·²ç»è¢«åˆ é™¤äº†
â€¢ 9.25 è®²è§£å®éªŒå†…å®¹
â€¢ 11.30 å®éªŒæäº¤æˆªæ­¢æ—¥æœŸ
â€¢ 12 æœˆ æ£€æŸ¥å®éªŒï¼Œæ—¶é—´å¾…å®š

Qingyu Wu

DNS Relay Lab

2025-10-05

26 / 41

C. Implementation

Architecture

C. Implementation ğŸ«

æ¥ä¸‹æ¥æˆ‘ä»¬å°†è®²è¿°æœ¬å®éªŒçš„å®éªŒæ¡†æ¶çš„å…·ä½“æ¶æ„ï¼š
â€¢ listen socket
â€£ å‘é€å’Œæ¥æ”¶å®¢æˆ·ç«¯ï¼ˆä¸»æœºï¼‰çš„ datagram
â€¢ upstream socket
â€£ å‘é€å’Œæ¥æ”¶ä¸Šæ¸¸ DNS çš„ datagram
â€¢ pending clients
â€£ è®°å½•ç”±äºæ— æ³• local resolve è€Œé˜»å¡çš„å®¢æˆ·ç«¯
â€¢ mappings
â€£ ç”¨äºæœ¬åœ°è§£æçš„ mappings æ–‡ä»¶

Qingyu Wu

DNS Relay Lab

2025-10-05

28 / 41

Architecture

C. Implementation ğŸ«

â€¢ epoll wait
â€£ ç­‰å¾…å¹¶æ¥æ”¶æ¥è‡ªå¤šä¸ª socket çš„ datagram
â€¢ handle listen
â€£ å¤„ç†æ¥è‡ª listen socket çš„ datagram
â€¢ handle upstream
â€£ å¤„ç†æ¥è‡ª upstream socket çš„ datagram
æ¯ä¸€ä¸ªåˆæ³•çš„åŸŸåè§£æè¿‡ç¨‹ä» DNS request å¼€å§‹ï¼Œ
åˆ° DNS response ç»“æŸã€‚
ä¸€å…±æœ‰æœ¬åœ°è§£æå’Œä¸­ç»§ä¸¤ç§åˆæ³•åŸŸåè§£æè¿‡ç¨‹ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

28 / 41

Architecture

C. Implementation ğŸ«

local resolve
ä» Host å¼€å§‹ï¼Œé€šè¿‡ listen socket è¢« epoll wait æ¥
æ”¶ï¼Œä¼ é€’ç»™ handle listenï¼Œè¯»å– mappings æ–‡ä»¶ï¼Œ
é€šè¿‡ listen socket å“åº”å› Hostã€‚
relay
ä» Host å¼€å§‹ï¼Œé€šè¿‡ listen socket è¢« epoll wait æ¥
æ”¶ï¼Œä¼ é€’ç»™ handle listenï¼Œé€šè¿‡ upstream socket ä¼ 
é€’ç»™ DNS Serverï¼Œé€šè¿‡ upstream socket è¢« epoll
wait æ¥æ”¶ï¼Œä¼ é€’ç»™ handle upstreamï¼Œé€šè¿‡ listen
socket å“åº”å› Hostã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

28 / 41

File Structure

C. Implementation ğŸ«

é™¤äº†æµ‹è¯•æ–‡ä»¶ã€æ„å»ºæ–‡ä»¶å’Œè¯´æ˜æ–‡ä»¶ï¼Œ
å®éªŒæ¡†æ¶ä¸»è¦ç”±ä»¥ä¸‹æºæ–‡ä»¶æ„æˆï¼š
â€¢ dns_relay.c å’Œ dns_relay.h
â€£ å®ç° socket çš„æ¥æ”¶å’Œå‘é€
â€£ å®ç° datagram çš„å¤„ç†é€»è¾‘
â€¢ dns_dgram_utils.c å’Œ
dns_dgram_utils.h

â€£ å®ç° datagram çš„è§£æå’Œä¿®æ”¹
â€£ å®ç°æœ¬åœ°è§£æ
â€¢ dns_relay_utils.h
â€£ ä¸€äº›æ–¹ä¾¿çš„è¾…åŠ©/å°è£…å‡½æ•°
Qingyu Wu

DNS Relay Lab

.
â”œâ”€â”€ benchmark_local.sh
â”œâ”€â”€ benchmark_remote.sh
â”œâ”€â”€ dns_benchmark.py
â”œâ”€â”€ dns_dgram_utils.c
â”œâ”€â”€ dns_dgram_utils.h
â”œâ”€â”€ dns_relay.c
â”œâ”€â”€ dns_relay.h
â”œâ”€â”€ dns_relay_utils.h
â”œâ”€â”€ mappings
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
2025-10-05

29 / 41

File Structure

C. Implementation ğŸ«

dns_relay.h ä¸­æœ‰ä¸€äº›å…¨å±€é…ç½®çš„å®ï¼š
// configs
#define LISTEN_ADDR "127.0.0.1"
#define LISTEN_PORT 53
#define UPSTREAM_ADDR
"114.114.114.114"
#define UPSTREAM_PORT 53

configs é‡Œå®šä¹‰äº† listen socket ç»‘å®šåœ°å€
å’Œç«¯å£å’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨åœ°å€å’Œç«¯å£

Qingyu Wu

DNS Relay Lab

.
â”œâ”€â”€ benchmark_local.sh
â”œâ”€â”€ benchmark_remote.sh
â”œâ”€â”€ dns_benchmark.py
â”œâ”€â”€ dns_dgram_utils.c
â”œâ”€â”€ dns_dgram_utils.h
â”œâ”€â”€ dns_relay.c
â”œâ”€â”€ dns_relay.h
â”œâ”€â”€ dns_relay_utils.h
â”œâ”€â”€ mappings
â”œâ”€â”€ Makefile
â””â”€â”€ README.md

2025-10-05

29 / 41

File Structure

C. Implementation ğŸ«

// policies
#define MAX_EVENTS 128
#define MAX_ANSWER_COUNT 8

policies é‡Œå®šä¹‰äº†æœ€å¤§å¹¶å‘æ¥æ”¶ datagram
æ•°ï¼Œæœ€å¤§å“åº”èµ„æºè®°å½•æ•°
// host file
#define HOST_FILE_PATH "./
mappings"

host file é‡Œå®šä¹‰äº†æœ¬åœ°è§£ææ‰€ä½¿ç”¨çš„
mappings æ–‡ä»¶è·¯å¾„
Qingyu Wu

DNS Relay Lab

.
â”œâ”€â”€ benchmark_local.sh
â”œâ”€â”€ benchmark_remote.sh
â”œâ”€â”€ dns_benchmark.py
â”œâ”€â”€ dns_dgram_utils.c
â”œâ”€â”€ dns_dgram_utils.h
â”œâ”€â”€ dns_relay.c
â”œâ”€â”€ dns_relay.h
â”œâ”€â”€ dns_relay_utils.h
â”œâ”€â”€ mappings
â”œâ”€â”€ Makefile
â””â”€â”€ README.md

2025-10-05

29 / 41

File Structure

C. Implementation ğŸ«

dns_relay_utils.h ä¸­å®šä¹‰äº†ä¸¤ä¸ªå®Œæˆå®

éªŒè¿‡ç¨‹ä¸­éœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼š
inline void send_datagram(int fd,
unsigned char *buf, int len,
client_info_t client_info)

å°† buf ä¸­ len å­—èŠ‚ datagram é€šè¿‡ fd çš„
socket å‘é€ç»™ client_info æŒ‡å®šçš„ client
inline void log_result(const char
*type, const char *name)

å°†åŸŸå name çš„è§£æè¿‡ç¨‹ type æ‰“å°å‡ºæ¥
Qingyu Wu

DNS Relay Lab

.
â”œâ”€â”€ benchmark_local.sh
â”œâ”€â”€ benchmark_remote.sh
â”œâ”€â”€ dns_benchmark.py
â”œâ”€â”€ dns_dgram_utils.c
â”œâ”€â”€ dns_dgram_utils.h
â”œâ”€â”€ dns_relay.c
â”œâ”€â”€ dns_relay.h
â”œâ”€â”€ dns_relay_utils.h
â”œâ”€â”€ mappings
â”œâ”€â”€ Makefile
â””â”€â”€ README.md

2025-10-05

29 / 41

File Structure

C. Implementation ğŸ«

dns_dgram_utils.h ä¸­å®šä¹‰äº† DNS

datagram çš„å„ç§ç»“æ„ï¼Œå¹¶ä½¿ç”¨ gcc æ‹“å±•
è¯­æ³• __attribute__((packed)) ä¿è¯
struct æ²¡æœ‰ paddingï¼Œä»è€Œæ–¹ä¾¿å®éªŒè¿‡ç¨‹
ä¸­ç›´æ¥å°†åŸå§‹äºŒè¿›åˆ¶æŠ¥æ–‡é€šè¿‡ä¸€ä¸ªç®€å•
çš„ç±»å‹è½¬æ¢è½¬æ¢æˆä¸€ä¸ªæŒ‡é’ˆï¼Œæ¯”å¦‚ï¼š
dns_header_t *dns_header =
(dns_header_t *) buf;

æ³¨æ„ dns_question_t çš„å®ç°å¹¶ä¸å®Œå…¨å¯¹
åº”ï¼Œå¯ä»¥é˜…è¯»æ³¨é‡ŠæŸ¥çœ‹åŸå› ã€‚
Qingyu Wu

DNS Relay Lab

.
â”œâ”€â”€ benchmark_local.sh
â”œâ”€â”€ benchmark_remote.sh
â”œâ”€â”€ dns_benchmark.py
â”œâ”€â”€ dns_dgram_utils.c
â”œâ”€â”€ dns_dgram_utils.h
â”œâ”€â”€ dns_relay.c
â”œâ”€â”€ dns_relay.h
â”œâ”€â”€ dns_relay_utils.h
â”œâ”€â”€ mappings
â”œâ”€â”€ Makefile
â””â”€â”€ README.md

2025-10-05

29 / 41

TODO

C. Implementation ğŸ«

ç»™å‡ºçš„å®éªŒæ¡†æ¶å·²ç»å®ç°äº†é™¤äº† handle listen ä»¥å¤–
çš„å…¨éƒ¨éƒ¨åˆ†ï¼Œè€Œä½ éœ€è¦å®ç°çš„å†…å®¹æœ‰ï¼š
â€¢ dns_dgram_utils.c é‡Œçš„æ‰€æœ‰å‡½æ•°
â€£ å®ç°å¹¶è°ƒç”¨è¿™äº›å‡½æ•°å¯ä»¥å¤§å¤§ç®€åŒ– handle
listen éƒ¨åˆ†çš„å®ç°
â€¢ dns_relay.c é‡Œçš„ handle listen éƒ¨åˆ†
â€£ è°ƒç”¨ dns_dgram_utils.c å’Œ
dns_relay_utils.c é‡Œçš„å‡½æ•°æ¥å®ç°è¯¥éƒ¨åˆ†
ä½ å¯ä»¥å‚è€ƒå³ä¾§çš„ç¤ºæ„å›¾æ¥äº†è§£å’Œå®Œæˆ handle
listen çš„å·¥ä½œåŸç†
Qingyu Wu

DNS Relay Lab

2025-10-05

30 / 41

D. Appendix

Introduction

D. Appendix ğŸ«

é™„å½•ä¸­æ”¶å½•äº†æœ¬å®éªŒæ¡†æ¶åœ¨å®ç°å®Œæˆåæ‰€æœ‰è°ƒç”¨çš„ Linux ç³»ç»Ÿæä¾›
çš„ä¸ç½‘ç»œç›¸å…³çš„åº“å‡½æ•°ï¼Œå…¶ä¸­:
â€¢ Linux Internet éƒ¨åˆ†çš„å‡½æ•°æ˜¯ä½ åœ¨å®ç° TODO è¿‡ç¨‹ä¸­ä¼šç›´æ¥ä½¿ç”¨çš„
å‡½æ•°
â€¢ Linux Socket éƒ¨åˆ†çš„å‡½æ•°æ˜¯ä½ åœ¨å®ç° TODO è¿‡ç¨‹ä¸­ä¸ä¼šç›´æ¥ä½¿ç”¨çš„
å‡½æ•°ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£å®éªŒæ¡†æ¶è€Œå†™ä¸Šæ¥çš„ã€‚
è‡³äºå…¶ä»–å‡½æ•°ï¼Œæ¯”å¦‚æ ‡å‡†åº“å‡½æ•°ï¼Œæ¡†æ¶é‡Œæä¾›çš„å‡½æ•°éƒ½æ˜¯å¯ä»¥ä½¿ç”¨
ä½†ä¸ä¸€å®šä¼šä½¿ç”¨çš„å‡½æ•°ï¼Œå®ç° TODO æ—¶è‡ªè¡Œæ–Ÿé…Œå³å¯ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

32 / 41

Linux Internet

D. Appendix ğŸ«

inet_pton()
int inet_pton (int __af, const char *__restrict __cp, void
*__restrict __buf)

å°†å­˜æ”¾åœ¨ __cp ä¸­çš„å­—ç¬¦ä¸²å½¢å¼çš„åœ°å€è½¬æ¢æˆäºŒè¿›åˆ¶å½¢å¼çš„åœ°å€å­˜æ”¾
åœ¨ __buf ä¸­ã€‚å¦‚æœè½¬æ¢æˆåŠŸï¼Œè¿”å› 1ï¼›å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å› 0ã€‚
æ¯”å¦‚å¯¹äº IPv4ï¼Œå°† "127.0.0.1" è½¬æ¢æˆ 0x7f000001ï¼Œå¹¶ä¸”ä¿è¯æ˜¯äº’
è”ç½‘åè®®è¦æ±‚çš„å¤§ç«¯åºè¡¨ç¤ºã€‚
åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œ__af ä¸º AF_INET æˆ– AF_INET6ï¼Œè¡¨ç¤º IPv4 æˆ– IPv6ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

33 / 41

Linux Internet

D. Appendix ğŸ«

inet_ntop()
const char *inet_ntop (int __af, const void *__restrict __cp,
char *__restrict __buf, socklen_t __len)

å°†å­˜æ”¾åœ¨ __buf ä¸­çš„äºŒè¿›åˆ¶å½¢å¼çš„åœ°å€è½¬æ¢æˆå­—ç¬¦ä¸²å½¢å¼å­˜æ”¾åœ¨
__cp ä¸­ã€‚å¦‚æœè½¬æ¢æˆåŠŸï¼Œè¿”å› 1ï¼›å¦‚æœè½¬æ¢å¤±è´¥ï¼Œè¿”å› 0ã€‚

æ¯”å¦‚å¯¹äº IPv6ï¼Œå°† 0xfe800000000000000000000000000001 è½¬æ¢æˆ
"fe80::1"ï¼Œå¹¶ä¸”ä¿è¯æ˜¯äº’è”ç½‘åè®®è¦æ±‚çš„å¤§ç«¯åºè¡¨ç¤ºã€‚

åœ¨æœ¬æ¬¡å®éªŒä¸­ï¼Œ__af ä¸º AF_INET æˆ– AF_INET6ï¼Œè¡¨ç¤º IPv4 æˆ– IPv6ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

34 / 41

Linux Internet

D. Appendix ğŸ«

ntohl()
uint32_t ntohl (uint32_t __netlong)
ntohs()
uint16_t ntohs (uint16_t __netshort)
htonl()
uint32_t htonl (uint32_t __hostlong)
htons()
uint16_t htons (uint16_t __hostshort)

ä»¥ä¸Šæ˜¯å¯¹äº 16 ä½å’Œ 32 ä½æ•°åœ¨ä¸»æœºåºå’Œç½‘ç»œå¤§ç«¯åºä¸­è½¬æ¢çš„å‡½æ•°
Qingyu Wu

DNS Relay Lab

2025-10-05

35 / 41

Linux Socket

D. Appendix ğŸ«

socket()
int socket(int __domain, int __type, int __protocol)

åœ¨ Linux ä¸‹ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå› æ­¤ socket ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡
ä»¶ã€‚åœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ›å»ºä¸€ä¸ª UDP socketï¼Œç”¨
æ¥æ¥æ”¶å’Œå‘é€ DNS datagramã€‚
int fd = socket(PF_INET, SOCK_DGRAM, 0)

å…¶ä¸­ï¼Œè¿”å›å€¼ fd è¡¨ç¤º file descriptorï¼Œç›¸å½“äºä¸€ç§æ ‡è¯†ä¸€ä¸ªè¢«æ‰“å¼€çš„
æ–‡ä»¶çš„å˜é‡ï¼Œä»è€Œç”¨äºå…¶ä»–å‡½æ•°è°ƒç”¨ï¼Œè´Ÿå€¼è¡¨ç¤ºåˆ›å»ºå¤±è´¥ã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

36 / 41

Linux Socket

D. Appendix ğŸ«

sendto()
ssize_t sendto (int __fd, const void *__buf, size_t __n, int
__flags, __CONST_SOCKADDR_ARG __addr, socklen_t __addr_len)

é¡¾åæ€ä¹‰ï¼Œå°† __buf ä¸­çš„ __n å­—èŠ‚å†…å®¹é€šè¿‡ __fd ä¸­å¯¹åº”çš„ socket å‘
é€åˆ° __addr å’Œ __addr_len è¡¨ç¤ºçš„ IP åœ°å€å’Œç«¯å£å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚
åœ¨æœ¬å®éªŒå®éªŒæ¡†æ¶ä¸­ï¼Œè¯¥å‡½æ•°è¢«ç®€å•åŒ…è£…æˆä¸€ä¸ª inline å‡½æ•°ï¼Œä»¥æ–¹
ä¾¿è°ƒç”¨ï¼š
inline void send_datagram(int fd, unsigned char *buf, int
len, client_info_t client_info)

Qingyu Wu

DNS Relay Lab

2025-10-05

37 / 41

Linux Socket

D. Appendix ğŸ«

bind()
int bind (int __fd, __CONST_SOCKADDR_ARG __addr, socklen_t
__len)

ä¸€ä¸ªæ–°å»ºçš„ socket å¯ä»¥ç›´æ¥ç”¨äºå‘é€ datagramï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…åˆ
é€‚çš„ç«¯å£å·ï¼Œä½†æ˜¯å¦‚æœè¦æ¥æ”¶ datagram å¹¶æŒ‡å®šç«¯å£ï¼Œæ¯”å¦‚æœ¬æ¬¡å®éªŒ
ä½¿ç”¨çš„ 53 ç«¯å£ï¼Œæˆ‘ä»¬å°±å¿…é¡» bind è¿™ä¸ª socket åˆ°è¿™ä¸ªç«¯å£ä¸Šï¼š
bind(listen_fd, (struct sockaddr*)&listen_addr,
sizeof(listen_addr))

å…¶ä¸­ï¼Œlisten_fd æ¥è‡ªä¹‹å‰åˆ›å»º socket çš„è¿”å›å€¼ï¼Œlisten_addr æ˜¯ä¸€ä¸ª
struct sockaddr_in
Qingyu Wu

ç±»å‹çš„å˜é‡ï¼Œç”¨äºæ ‡è¯†ç»‘å®šçš„ç½‘æ®µå’Œç«¯å£ã€‚
DNS Relay Lab

2025-10-05

38 / 41

Linux Socket

D. Appendix ğŸ«

recvfrom()
ssize_t recvfrom (int __fd, void *__restrict __buf, size_t
__n, int __flags, __SOCKADDR_ARG __addr, socklen_t
*__restrict __addr_len)

é¡¾åæ€ä¹‰ï¼Œå½“ __fd æ‰€æ ‡è¯†çš„ socket æ¥æ”¶åˆ°äº†ä»»ä½• datagramï¼Œé‚£ä¹ˆå°±
ä¼šå°† datagram æ”¾åˆ° __buf é‡Œï¼Œè¶…è¿‡ __n å­—èŠ‚çš„éƒ¨åˆ†ç›´æ¥æˆªæ–­ï¼Œæœ€å
æŠŠå‘é€ datagram çš„å®¢æˆ·ç«¯çš„ IP åœ°å€å’Œç«¯å£ä¿¡æ¯æ”¾åœ¨ __addr ä¸‹ï¼Œæœ€
å¤šä¸èƒ½è¶…è¿‡ __addr_len ä¸ªå­—èŠ‚ã€‚
int len = recvfrom(event_fd, buf, MAX_DATAGRAM_BUFFER_SIZE,
0, (struct sockaddr *)&client_info.addr, &client_info.len)

Qingyu Wu

DNS Relay Lab

2025-10-05

39 / 41

Linux Socket

D. Appendix ğŸ«

recvfrom()
ssize_t recvfrom (int __fd, void *__restrict __buf, size_t
__n, int __flags, __SOCKADDR_ARG __addr, socklen_t
*__restrict __addr_len)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè°ƒç”¨è¯¥å‡½æ•°æ—¶ __fd æ ‡è¯†çš„ socket æ²¡æœ‰æ¥æ”¶åˆ°ä»»
ä½• datagramï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®è¯¥ __fd çš„ flag é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š
â€¢ O_NONBLOCKï¼šå¤±è´¥ï¼Œç›´æ¥è¿”å› âˆ’1
â€¢ é»˜è®¤ï¼šé˜»å¡ï¼Œç›´åˆ°æ”¶åˆ°ä»»ä½• datagram
int len = recvfrom(event_fd, buf, MAX_DATAGRAM_BUFFER_SIZE,
0, (struct sockaddr *)&client_info.addr, &client_info.len)
Qingyu Wu

DNS Relay Lab

2025-10-05

39 / 41

Linux Socket

D. Appendix ğŸ«

epoll_ctl()
int epoll_ctl (int __epfd, int __op, int __fd, struct
epoll_event *__event)
epoll_wait()
int epoll_wait (int __epfd, struct epoll_event *__events, int
__maxevents, int __timeout)

è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯ç”¨æ¥é«˜æ•ˆå¤„ç†æ¥è‡ªå¤šä¸ªæ¥æ”¶çŠ¶æ€ä¸‹çš„ socket çš„
datagram çš„ï¼Œå…·ä½“åŸç†ä¸æœ¬è¯¾æ— å…³ï¼Œå› æ­¤ä¸è¿‡å¤šè®²è§£ï¼Œä»…ä»…åªéœ€è¦
çŸ¥é“ä½¿ç”¨ epoll æœºåˆ¶èƒ½å¤Ÿä¿è¯æ¯æ¬¡è°ƒç”¨ recvfrom() æ—¶ä¸€å®šæˆåŠŸï¼Œè€Œ
ä¸ä¼šé˜»å¡æˆ–è€…å¤±è´¥ã€‚
Qingyu Wu

DNS Relay Lab

2025-10-05

40 / 41

Linux Socket

D. Appendix ğŸ«

close()
int close (int __fd)

å…³é—­ä¸€ä¸ªå·²ç»æ‰“å¼€çš„ fdï¼Œä»¥åŠå…³è”çš„ socketã€‚

Qingyu Wu

DNS Relay Lab

2025-10-05

41 / 41

